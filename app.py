from flask import Flask, render_template, send_from_directory, url_for, request
import os
import base64
import requests  # æ–°å¢ï¼šä¿æ´»ä»»åŠ¡éœ€è¦
import time      # æ–°å¢ï¼šä¿æ´»ä»»åŠ¡éœ€è¦

# 1. åˆå§‹åŒ–Flaskåº”ç”¨ï¼ˆå¤ç”¨åŒä¸€ä¸ªappï¼Œæ— éœ€ä¿®æ”¹ï¼‰
app = Flask(__name__, template_folder='templates', static_folder='static')

# 2. å›¾ç‰‡å¤„ç†å‡½æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
def get_image_base64(keyword):
    for filename in os.listdir(app.static_folder):
        if keyword in filename and filename.split('.')[-1] in ['png', 'jpg', 'jpeg']:
            with open(os.path.join(app.static_folder, filename), 'rb') as f:
                return base64.b64encode(f.read()).decode()
    return ""

# 3. å“²å­¦ç¤¾ä¿¡ä»¶ï¼ˆå®Œæ•´ä¿ç•™ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
PHILOSOPHY_LETTER = """ç¦æ¸…ä¸€ä¸­â€œå‡Œç©ºâ€å“²å­¦ç¤¾ç»™æ–°ç”Ÿä»¬çš„ä¸€å°ä¿¡

To å³å°†è¿›å…¥ä¸€ä¸­çš„å­¦å¼Ÿå­¦å¦¹ä»¬ï¼š

è§å­—å¦‚é¢ï¼

â€œæˆ‘æœ‰ä¸é‡Šå·ï¼Œä¸å›å…±èµä¹‹â€ã€‚åœ¨è¿™ä¸ªèº«é—²æ—¶å¥½çš„å¤å¤©ï¼Œç¦æ¸…ä¸€ä¸­â€œå‡Œç©ºâ€å“²å­¦ç¤¾è¯šæŒšåœ°é‚€è¯·æ‚¨åŠ å…¥æœ¬ç¤¾ï¼Œå…±è¯å¤ä»Šå“²æ€ä¹‹ç†ï¼ŒåŒå¯»çœŸç†ä»·å€¼æ‰€åœ¨ã€‚è‹¥é—®ç¼˜ç”±ï¼Œä¸”çœ‹ä»¥ä¸‹å››ç‚¹æ˜¯å¦è¶³ä»¥è®©ä½ å¿ƒåŠ¨ï¼š

1.æœ¬ç¤¾æ—¢åæ›°â€œå“²å­¦ç¤¾â€ï¼Œè‡ªç„¶æ˜¯ä»¥å“æå“²å­¦ä¸ºå®—æ—¨ã€‚è€Œâ€œå“²å­¦â€ä½œä¸ºâ€œçˆ±æ™ºä¹‹å­¦â€ï¼Œå“æä¹‹ä¸‹ä¸”ä¸è®ºé‚£äº›â€œè¯æ˜å®‡å®™ä¸­è‡ªç„¶å¾‹çš„å­˜åœ¨â€ç­‰å®å¤§å‘½é¢˜å¸¦ç»™äººç±»çš„ä»·å€¼ï¼Œå•å•å¯¹äºé«˜ä¸­ç”Ÿè€Œè¨€ï¼Œå“æå“²å­¦å¯ä»¥å¸®åŠ©ä½ æ¥è¿‘â€œä¸­å¼æ•™è‚²ä¸‹å­¦ä¹ çš„æ„ä¹‰æ‰€åœ¨â€â€œæ‰€è°“â€˜çœŸçˆ±â€™åˆ°åº•æ˜¯ä¸æ˜¯ä¸€ä¸ªè°è¨€â€â€œè‡ªç”±æ„å¿—æ˜¯å¦å­˜åœ¨â€ç­‰ä¸ç²¾ç¥ç”Ÿæ´»æ¯æ¯ç›¸å…³çš„é—®é¢˜çš„ç­”æ¡ˆï¼Œæœ€ä¸æµä»åŠŸåˆ©ä¸»ä¹‰çš„è§’åº¦çœ‹ä¹Ÿå¯ä»¥æå‡ä½ çš„æ•°å­¦é€»è¾‘æ¨ç†å’Œè¯­æ–‡è®®è®ºæ–‡æ€è¾¨ç­‰èƒ½åŠ›ã€‚

2.å“²å­¦ç¤¾ç›®å‰æš‚å®šä¸»è¦å¼€å±•ä¸¤é¡¹æ´»åŠ¨ï¼Œåˆ†åˆ«ä¸ºâ€œç™¾å®¶è®²å›â€å’Œè¾©è®ºèµ›ã€‚å…¶ä¸­â€œç™¾å®¶è®²å›â€æš‚å®šç”±ä¸¤ä½å‰¯ç¤¾é•¿ä¸»è®²ï¼ˆå³ä¸ºâ€œç™¾å®¶â€ï¼Œå½“ç„¶ä¸æ’é™¤æ–°äººï¼Œä¹Ÿå°±æ˜¯åœ¨çœ‹è¿™å°ä¿¡çš„ä½ ä»¬ä¸­çš„æ½œåœ¨è®²å¸ˆï¼‰ï¼Œå†…å®¹æ¶µç›–äº† è¥¿æ–¹å“²å­¦å²ï¼Œå„ç±»å“²å­¦å‘½é¢˜å’Œå„å“²å­¦æµæ´¾ï¼ˆå³å„ç§â€œä¸»ä¹‰â€ï¼‰çš„ä»‹ç»ï¼Œæ—¨åœ¨å¸®åŠ©ç¤¾å‘˜ä»¬å…¥é—¨å“²å­¦å¹¶ä¸€å®šç¨‹åº¦åœ°ç³»ç»Ÿåœ°äº†è§£å“²å­¦çŸ¥è¯†ã€‚æ­¤å¤–ï¼Œåœ¨â€œç™¾å®¶è®²å›â€å¼€å±•åˆ°ä¸€å®šç¨‹åº¦ä¹‹åï¼Œæœ¬ç¤¾æš‚å®šåœ¨ç”¨ä¸€æ¬¡ç¤¾å›¢æ´»åŠ¨æ—¶é—´æ¥ä»‹ç»è¾©è®ºçš„è§„åˆ™&æŠ€å·§&è¦æ±‚çš„åŸºç¡€ä¸Šï¼Œç©¿æ’è¿›è¡Œè¾©è®ºèµ›ï¼Œæ—¨åœ¨è®©ç¤¾å‘˜ä»¬äºæ„è¯†å½¢æ€æ— æ¯”æ¾æ¹ƒçš„ç°åœºä¸­è¿ç”¨å“²å­¦çŸ¥è¯†ä»¥è·å¾—æ€è¾¨çš„å¿«ä¹ã€‚

3.å“²å­¦ç¤¾æå…¶å°Šé‡ç¤¾å‘˜ä»¬çš„è¨€è®ºè‡ªç”±ï¼Œeveryoneçš„ä»»ä½•çœ‹æ³•å’Œæ„è§ç»ç”±æˆ‘ä»¬çé‡åœ°å®¡è§†åéƒ½å¯èƒ½å½±å“æœ€ç»ˆå†…å®¹çš„å‘ˆç°ã€‚æ¢è¨€ä¹‹ï¼Œâ€œå‡Œç©ºâ€å“²å­¦ç¤¾åˆ°åº•ä¼šæˆä¸ºæ€æ ·çš„ä¸€ä¸ªç¤¾å›¢ï¼Œå…¶å†³å®šæƒåœ¨æ¯ä¸ªç¤¾å‘˜æ‰‹ä¸­ã€‚

4.å…¶ä½™è¯·å‚è§å“²å­¦ç¤¾æ‹›æ–°è§†é¢‘ï¼ˆçº¦å…«æœˆå‘å¸ƒï¼‰

æœ€åï¼Œæˆ‘ä»¬æƒ³è¯´ï¼šå…¶å®é€‰æ‹©æ²¡æœ‰ç»å¯¹çš„å¯¹é”™ï¼Œæœªæ¥å°šè¿œï¼Œè¿‡å»å·²å»ï¼Œæ—¶é—´ä¼šè¯æ˜ä¸€åˆ‡ã€‚å¦‚æœè¯´å°±è¯»äºç¦æ¸…ä¸€ä¸­æ˜¯ä½ äººç”Ÿæ—…é€”ä¸­çš„å¿…ç»ä¹‹è·¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›â€œå‡Œç©ºâ€å“²å­¦ç¤¾èƒ½æˆä¸ºä½ ä»¬æ²¿é€”ä¸­â€œæµ®ç”Ÿæš‚å¯„æ¢¦ä¸­æ¢¦ï¼Œä¸€æ™Œè´ªæ¬¢â€çš„ç‰‡åˆ»ä¹Œæ‰˜é‚¦ï¼ŒçœŸçš„ï¼Œæ—¶é—´ä¼šè¯æ˜ä½ ä»¬é€‰æ‹©çš„ä»·å€¼ã€‚

P.S. æœ€åçš„æœ€åï¼Œè‹¥æœ‰æ„æ„¿åŠ å…¥å“²å­¦ç¤¾è€…ï¼Œè¯·æ‰«ç å…¥ç¾¤äº†è§£æ›´å¤šè®¯æ¯
ç¾¤å·ï¼š981094818

è‹¥ä»æœ‰ç–‘é—®ï¼Œæ¬¢è¿æ·»åŠ å­¦é•¿å­¦å§ QQ
ç¤¾é•¿ï¼š3657165489
å‰¯ç¤¾ Lï¼š229912402
å‰¯ç¤¾ Fï¼š3579577741
å‰¯ç¤¾ Yï¼š3083019832

ç¥ï¼Œ
æ¯ä¸ªåŠ å…¥å“²å­¦ç¤¾çš„åŒå­¦éƒ½èƒ½åœ¨è¿™é‡ŒçŸ¥é“è‡ªå·±æƒ³çŸ¥é“çš„ä¸€åˆ‡ï¼

æŸå‰¯ç¤¾é•¿
2025å¹´ä¸ƒæœˆäºå‡¤å‡°å±±"""

# 4. å‰ç«¯æ ¸å¿ƒæ•°æ®ï¼ˆresourcesåç»­ç”Ÿæˆï¼Œæ— éœ€ä¿®æ”¹ï¼‰
CORE_DATA = {
    "people": [
        {"name": "çŸ¥å¤©æ˜“", "title": "ç›Ÿä¸»", "intro": "æ›¾è·ç‰©ç†ç«èµ›çœä¸€"},
        {"name": "æ½¦è‰æ‚è‰æ±¤", "title": "æ–‡ç§‘éƒ¨ä¸»ä»»", "intro": "æ›¾è·ç¦æ¸…å¸‚æ–°æ—¶ä»£å¥½å°‘å¹´"},
        {"name": "é£å¹ä¸åŠ¨", "title": "å‰¯ç›Ÿä¸»", "intro": "åˆ›å§‹äºº"},
        {"name": "è¢«çŒ«åƒäº†", "title": "è”ç›Ÿé©»ä¿¡æ¯ç¤¾å¤–äº¤å®˜", "intro": "ä½è°ƒçš„ä¿¡ç«ç”Ÿ"},
        {"name": "è“è“é…¸", "title": "æµ‹è¯•éƒ¨ä¸»ä»»", "intro": "åŠæ—¶é›¨"}
    ],
    "timeline": [
        {"date": "2025/02/03", "event": "é£å¹ä¸åŠ¨å’Œæ½¦è‰æ‚è‰æ±¤ ç”¨é’±å¸®åŠ©äº†ä¸€ä½åœ¨å¯’é£ä¸­è¾›è‹¦å–èœçš„å‰Šç˜¦è€äººï¼Œé’å®¢è”ç›Ÿçš„ç²¾ç¥ç”±æ­¤èŒå‘ "},
        {"date": "2025/07/13", "event": "é£å¹ä¸åŠ¨ç€æ‰‹ç»¼è¯„è‡ªåŠ¨åŒ–ç¨‹åºç¼–å†™å¹¶åˆ›ç«‹é’å®¢è”ç›Ÿ"},
        {"date": "2025/07/15", "event": "ä¸€è‡´é€šè¿‡çŸ¥å¤©æ˜“å»ºè®®ï¼Œé£å¹ä¸åŠ¨å¼€æ”¾ç»¼è¯„è‡ªåŠ¨åŒ–ç›¸å…³æºä»£ç "},
        {"date": "2025/07/16", "event": "é£å¹ä¸åŠ¨ä»»å‘½çŸ¥å¤©æ˜“ä¸ºä»£ç†ç›Ÿä¸»"},
        {"date": "2025/08/08", "event": "çŸ¥å¤©æ˜“æ¥ä»»ç›Ÿä¸»"},
        {"date": "2025/08/16", "event": "ä¸ºäº†çºªå¿µæ—¥æœ¬å®£å¸ƒæ— æ¡ä»¶æŠ•é™80å‘¨å¹´é£å¹ä¸åŠ¨å’Œæ½¦è‰æ‚è‰æ±¤ç”¨Pythonå¼€å‘äº†ä¸€æ¬¾æ–‡å­—æ¸¸æˆã€Šé’æ˜¥è®°å¿†1931-1945ã€‹ï¼Œå¹¶ä¸Šä¼ æŠ–éŸ³ã€‚éš”æ—¥é£å¹ä¸åŠ¨è°ƒæ•´è”ç›ŸèŒè´£å½’å±"}
    ],
    "qq_group": "874636477",
    "friend_link": {"name": "ç¦æ¸…ä¸€ä¸­ä¿¡æ¯ç¤¾", "url": "https://guess.gsqclub.cn/account/registerStep1.php"},
    "open_source_license": "MIT License",
    "philosophy_button": "ã€Œå‡Œç©ºã€å“²å­¦ç¤¾ï¼Œæ¥çœ‹çœ‹å—ï¼Ÿ",
    "resources": []
}

# 5. å®šä¹‰è·¯ç”±ï¼ˆä¿ç•™åŸæ‰€æœ‰è·¯ç”±ï¼Œæ–°å¢ä¿æ´»è·¯ç”±ï¼‰
@app.route('/download/<filename>')
def download_file(filename):
    download_path = os.path.join(app.static_folder, 'download', filename)
    return send_from_directory(os.path.dirname(download_path), filename, as_attachment=True) if os.path.exists(download_path) else ("æ–‡ä»¶æœªæ‰¾åˆ°", 404)

@app.route('/philosophy')
def philosophy_page():
    return render_template('philosophy.html', letter=PHILOSOPHY_LETTER, poster=get_image_base64("å“²å­¦ç¤¾æµ·æŠ¥"), qr_code=get_image_base64("å“²å­¦ç¤¾äºŒç»´ç "), logo=get_image_base64("å“²å­¦ç¤¾å›¾æ ‡"))

@app.route('/')
def index_page():
    is_mobile = 'mobile' in request.user_agent.string.lower()
    imgs = {
        "logo_b64": get_image_base64("é’å®¢è”ç›Ÿå›¾æ ‡"),
        "qrcode_b64": get_image_base64("é’å®¢è”ç›ŸäºŒç»´ç "),
        "poster_b64": get_image_base64("æ–‡å¨±éƒ¨å®£ä¼ æµ·æŠ¥"),
        "philosophy_icon": get_image_base64("å“²å­¦ç¤¾å›¾æ ‡"),
        "philosophy_link": url_for('philosophy_page')
    }
    return render_template('mobile_index.html' if is_mobile else 'pc_index.html', **imgs, **CORE_DATA)

# æ–°å¢ä¿æ´»è·¯ç”±ï¼ˆæ”¹è·¯å¾„ä¸º/keep-aliveï¼Œé¿å…ä¸ä¸»è·¯ç”±/å†²çªï¼‰
@app.route('/keep-alive')
def fake_web():
    return "I'm just a keep-alive bot ğŸ¤«"

# 6. ç”Ÿæˆä¸‹è½½èµ„æºï¼ˆè·¯ç”±å®šä¹‰åï¼Œä¸Šä¸‹æ–‡å†…æ‰§è¡Œï¼Œæ— éœ€ä¿®æ”¹ï¼‰
with app.test_request_context():
    download_dir = os.path.join(app.static_folder, 'download')
    if os.path.exists(download_dir):
        CORE_DATA["resources"] = [{"name": f, "url": url_for('download_file', filename=f)} for f in os.listdir(download_dir) if os.path.isfile(os.path.join(download_dir, f))]

# æ–°å¢ä¿æ´»ä»»åŠ¡å‡½æ•°ï¼ˆå®Œå…¨å¤ç”¨åŸä»£ç ï¼Œæ— ä¿®æ”¹ï¼‰
def keep_alive_task():
    TARGETS = [
        "https://qklm.xyz",       # é¡¹ç›®1
        "https://wyb.qklm.xyz",   # é¡¹ç›®2
        "https://twobaohuo1.onrender.com"  # æœåŠ¡AåŸŸå
    ]
    while True:
        for url in TARGETS:
            try:
                requests.get(url, timeout=10)
                print(f"âœ… è®¿é—® {url} æˆåŠŸ")
            except Exception as e:
                print(f"âŒ è®¿é—® {url} å¤±è´¥: {str(e)}")
        time.sleep(120)  # æ¯2åˆ†é’Ÿå¾ªç¯

# 7. å¯åŠ¨åº”ç”¨ï¼ˆä¿®æ”¹å¯åŠ¨é€»è¾‘ï¼Œæ·»åŠ ä¿æ´»çº¿ç¨‹ï¼‰
if __name__ == '__main__':
    import threading  # æ–°å¢ï¼šå¯åŠ¨åå°çº¿ç¨‹éœ€è¦
    t = threading.Thread(target=keep_alive_task)
    t.daemon = True
    t.start()
    # ä¿ç•™åŸå¯åŠ¨ä»£ç ï¼Œæ— ä¿®æ”¹
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)), debug=False)
